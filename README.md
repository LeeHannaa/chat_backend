### 디디하우스 채팅 기능 서비스

1. **소개**
   - 디디하우스 앱/웹 내 채팅 기능 도입 (1:1) -> 단체 채팅 확장
2. **기간**
   - 2025.02.13 ~
   - (2025.02.21 ~ 2025.03.06 병결)
3. **채팅 기능 개발 과정**
   1. **웹소켓 통신을 통한 실시간 채팅**
       1. **구독 경로는 현재 두가지**
           1. **특정 채팅방 구독**
               1. 해당 채팅방에 접속하여 실시간으로 채팅 진행
           2. **유저의 아이디 구독**
               1. 각 유저는 자신의 아이디로 구독 경로 접속 (채팅방 목록에서)
               2. 메시지를 전송하게 될 경우 받는 사람의 아이디를 찾아 해당 경로로 메시지 전송
               3. 실시간 알림 및 마지막 채팅 내역 확인
       2. **전송 타입 지정**
           - **CHAT** (채팅 전송 알림)
           - **INFO** (상대가 채팅방에 입장 알림) - 읽음 처리 해야하는 메시지 수 같이 전달
           - **OUT** (상대가 채팅방에 퇴장 알림)
           - **INVITE** (채팅방에 유저 초대 알림)
           - **LEAVE** (유저가 채팅방을 나갔다는 알림) -  읽음 처리 해야하는 메시지 수 같이 전달
           - **DELETE** (채팅 메시지 전체 삭제 알림) - 전체 삭제 한 메시지 id : “삭제된 메시지입니다.” 처리
   2. **Redis를 사용해 읽음/안읽음 처리**
       1. **Redis에 저장하는 데이터 현재 세가지**
           1. **현재 특정 채팅방 접속자 수**
               1. 실시간 접속자 수를 체크하여 채팅방 접속 여부 확인 → 실시간으로  소켓을 통해 입장/퇴장 정보를 전달함으로 ui에서 읽음/안읽음 처리 실시간 반영
           2. **해당 채팅방에 채팅을 안읽은 사용자가 있는지 확인 (읽지 않은 사용자 id 저장)**
               1. 단순히 채팅방에 안읽은 메시지의 여부를 확인 ⇒ 안읽은 메시지가 없다면 아래의 단계 실행하지 않음
               2. **단체 채팅으로 확장 시 변경된 부분**
                  1. 채팅방에 실시간으로 접속한 유저 수를 저장하는 것뿐만 아니라 userId를 같이 저장
           3. **누가 안읽었는지 확인**
               1. 해당 채팅방에 안읽은 메시지가 있다면 myId와 receiverId를 비교
               2. 동일하다면 내가 안읽은 것이므로 redis에서 삭제 (읽음처리)
               3. 동일하지 않다면 상대가 안읽은 것이므로 몇개의 메시지를 안읽었는지 데이터 전달 → 안읽은 메시지 수만큼 ui에서 ‘안읽음’처리
               4. **단체 채팅으로 확장 시 변경된 부분**
                  1. 각 메시지 당 몇명이 읽었는지 확인
                     1. Redis에 각 메시지마다 누가 읽지 않았는지 정보 저장
                     2. 각 메시지 당 안읽은 수 계산 : SCARD (Set 크기)
   3. **Cassandra DB를 사용해 대용량 채팅 메시지 데이터 저장**
       1. 수평적 확장성으로 특정 노드에 부하가 몰리지 않도록 데이터가 클러스터 전체에 자동으로 분산
       2. 하나의 노드에 장애가 발생해도 전체 시스템은 계속 작동
       3. 대용량의 데이터를 빠르게 쓰기/읽기
   4. **FCM 알림**
       1. Firebase의 FCM 기능을 이용해 어플리케이션에서 알림 전송
       2. 클라이언트 측에서 fcm token을 받아와 서버로 전달하여 db에 저장 (한 유저 당 하나 → 추후 확장한다면 한 유저당 fcm token을 여러개 가질 수 있도록 가능할 것 같음)
       3. 실시간 메시지가 전송되는 과정에서 fcm token이 있다면 해당 토큰을 이용해 알림 전송
4. **채팅 api 기능 명세**
   - <a href="https://www.notion.so/API-1b9caaf36f6f808db6eee3bce373178d" style="color: black;">API 기능 명세 정리 바로가기</a>
5. **ERD**
    - <a href="https://www.erdcloud.com/d/vmsZPJZMG8u2Trsdi" style="color: black;">ERD 바로가기</a>
    
